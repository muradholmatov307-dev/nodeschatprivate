<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Node P2P</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-main: #313338;
            --bg-side: #2b2d31;
            --bg-chat: #313338;
            --text-main: #dbdee1;
            --accent: #5865f2;
            --danger: #f23f42;
            --success: #23a559;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'gg sans', 'Noto Sans', sans-serif; background: #000; overflow: hidden; }
        
        /* Экран блокировки */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #1e1f22; z-index: 9999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; color: white;
        }

        .app-container { display: flex; height: 100vh; width: 100vw; background: var(--bg-main); display: none; }
        
        /* Сайдбар */
        .sidebar { width: 240px; background: var(--bg-side); display: flex; flex-direction: column; padding: 10px; border-right: 1px solid #262729; }
        .id-card { background: #1e1f22; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        
        /* Чат */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { display: flex; flex-direction: column; color: var(--text-main); }
        .msg b { color: #fff; font-size: 14px; margin-bottom: 4px; }
        .msg-content { background: #383a40; padding: 10px; border-radius: 8px; align-self: flex-start; max-width: 80%; }
        .sticker { max-width: 250px; border-radius: 8px; margin-top: 5px; display: block; border: 1px solid #444; }

        /* Ввод */
        .input-box { padding: 20px; background: var(--bg-chat); }
        .input-wrapper { background: #383a40; border-radius: 8px; display: flex; padding: 10px; gap: 10px; }
        input { border: none; background: none; color: white; flex: 1; outline: none; font-size: 15px; }

        /* Звонок */
        .call-overlay {
            position: fixed; top: 20px; right: 20px; width: 300px; background: #1e1f22; 
            border-radius: 12px; padding: 20px; box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            display: none; text-align: center; color: white; border: 1px solid var(--accent); z-index: 1000;
        }
        
        .btn { border: none; border-radius: 4px; padding: 10px 20px; cursor: pointer; color: white; font-weight: bold; }
        .btn-blue { background: var(--accent); }
        .btn-red { background: var(--danger); }
        .btn-green { background: var(--success); }
    </style>
</head>
<body>

<div id="lock-screen">
    <i class="fab fa-discord fa-4x" style="color: var(--accent); margin-bottom: 20px;"></i>
    <div id="lock-status">Проверка доступа по IP...</div>
</div>

<div class="call-overlay" id="call-ui">
    <div style="margin-bottom: 15px;"><b id="caller-name">Входящий вызов...</b></div>
    <div style="display: flex; justify-content: space-around;">
        <button class="btn btn-green" onclick="answerCall()"><i class="fas fa-phone"></i> Принять</button>
        <button class="btn btn-red" onclick="rejectCall()"><i class="fas fa-phone-slash"></i> Отклонить</button>
    </div>
    <audio id="ringtone" loop src="https://www.soundjay.com/phone/phone-calling-1.mp3"></audio>
</div>

<div class="app-container" id="app">
    <div class="sidebar">
        <div class="id-card">
            <div style="font-size: 11px; color: #aaa; margin-bottom: 5px;">ВАШ ID</div>
            <div id="my-id" style="color: var(--accent); font-weight: bold; cursor:pointer;" onclick="copyID()">ЗАГРУЗКА...</div>
        </div>
        <button class="btn btn-blue" onclick="startCall()" style="width:100%"><i class="fas fa-video"></i> Позвонить</button>
        <div style="margin-top: 20px;">
            <input type="text" id="peer-id-input" placeholder="ID друга" style="width: 80%; background: #1e1f22; margin-bottom: 10px; border-radius: 4px; padding: 8px;">
            <button class="btn btn-blue" onclick="connectToPeer()" style="width:100%">Подключить чат</button>
        </div>
    </div>

    <div class="chat-area">
        <div id="messages"></div>
        <div class="input-box">
            <div class="input-wrapper">
                <button style="background:none; border:none; color: #b5bac1; cursor:pointer;" onclick="document.getElementById('file-input').click()"><i class="fas fa-plus-circle fa-lg"></i></button>
                <input type="text" id="msg-input" placeholder="Написать сообщение..." onkeypress="if(event.key==='Enter') sendMsg()">
                <input type="file" id="file-input" style="display:none" onchange="sendFile(this)">
            </div>
        </div>
    </div>
</div>

<script>
    // --- НАСТРОЙКИ ДОСТУПА ---
    const allowedIPs = ['188.19.61.123', '127.0.0.1']; // Впиши сюда IP тех, кому можно входить

    async function checkAccess() {
        try {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json();
            const userIP = data.ip;

            if (allowedIPs.includes(userIP)) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                initPeer();
            } else {
                document.getElementById('lock-status').innerHTML = `<span style="color:red">ОТКАЗАНО: Твой IP (${userIP}) не в списке.</span>`;
            }
        } catch (e) {
            document.getElementById('lock-status').innerText = "Ошибка проверки IP. Обновите страницу.";
        }
    }

    // --- LOGIC ---
    let myId = Math.random().toString(36).substr(2, 5).toUpperCase();
    let peer, conn, currentCall;

    function initPeer() {
        peer = new Peer('DS-' + myId, { config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]} });
        
        peer.on('open', id => document.getElementById('my-id').innerText = myId);
        
        peer.on('connection', c => { conn = c; setupConn(); });
        
        peer.on('call', call => {
            currentCall = call;
            document.getElementById('call-ui').style.display = 'block';
            document.getElementById('ringtone').play();
        });
    }

    function setupConn() {
        conn.on('data', data => {
            if (data.file) handleFile(data);
            else renderMsg("Собеседник", data);
        });
    }

    function sendMsg() {
        const val = document.getElementById('msg-input').value;
        if(!val || !conn) return;
        conn.send(val);
        renderMsg("Вы", val, true);
        document.getElementById('msg-input').value = '';
    }

    function renderMsg(user, text, isOwn = false) {
        const messages = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = 'msg';
        
        // Проверка на картинку/стикер
        const isImg = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))/i.test(text);
        const content = isImg ? `<img src="${text}" class="sticker">` : text;

        div.innerHTML = `<b>${user}</b><div class="msg-content">${content}</div>`;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    function connectToPeer() {
        const tid = document.getElementById('peer-id-input').value.toUpperCase();
        conn = peer.connect('DS-' + tid);
        setupConn();
        renderMsg("Система", "Запрос на соединение отправлен...");
    }

    async function startCall() {
        const tid = document.getElementById('peer-id-input').value.toUpperCase();
        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
        const call = peer.call('DS-' + tid, stream);
        call.on('stream', s => playStream(s));
    }

    function answerCall() {
        navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
            currentCall.answer(stream);
            currentCall.on('stream', s => playStream(s));
            stopRingtone();
        });
    }

    function rejectCall() {
        stopRingtone();
        currentCall.close();
        document.getElementById('call-ui').style.display = 'none';
    }

    function stopRingtone() {
        document.getElementById('ringtone').pause();
        document.getElementById('call-ui').style.display = 'none';
    }

    function playStream(stream) {
        const audio = new Audio();
        audio.srcObject = stream;
        audio.play();
        renderMsg("Система", "Звонок активен");
    }

    function copyID() {
        navigator.clipboard.writeText(myId);
        alert("ID скопирован!");
    }

    checkAccess();
</script>
</body>
</html>
