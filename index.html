<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Private Node</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #0a0a0a; --panel: #141414; --text: #00ff41; --border: #00ff41; --msg: #111; --accent: #00ff41; }
        [data-theme="light"] { --bg: #ffffff; --panel: #f0f0f0; --text: #222; --border: #333; --msg: #e1e1e1; --accent: #007bff; }

        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; margin: 0; padding: 10px; transition: 0.3s; }
        .app { max-width: 500px; margin: auto; border: 1px solid var(--border); background: var(--panel); position: relative; }
        
        .header { background: #000; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        #chat { height: 400px; overflow-y: auto; padding: 15px; background: var(--bg); display: flex; flex-direction: column; gap: 8px; }
        
        .m { padding: 8px 12px; background: var(--msg); border: 1px solid var(--border); max-width: 85%; align-self: flex-start; }
        .m.own { align-self: flex-end; border-color: #888; }
        .m b { font-size: 10px; opacity: 0.7; display: block; margin-bottom: 4px; }
        
        .sticker { max-width: 120px; display: block; margin-top: 5px; cursor: pointer; }
        .sticker-panel { display: none; padding: 10px; background: var(--panel); border-top: 1px solid var(--border); grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .sticker-panel img { width: 100%; cursor: pointer; border: 1px solid transparent; }
        .sticker-panel img:hover { border-color: var(--accent); }

        .controls { padding: 10px; background: var(--panel); border-top: 1px solid var(--border); }
        .row { display: flex; gap: 5px; margin-bottom: 8px; }
        
        input { flex: 1; background: #000; border: 1px solid var(--border); color: var(--text); padding: 10px; outline: none; }
        [data-theme="light"] input { background: #fff; color: #000; }
        
        button { background: transparent; color: var(--text); border: 1px solid var(--border); padding: 8px 12px; cursor: pointer; transition: 0.2s; }
        button:hover { background: var(--text); color: #000; }
        
        .call-ui { display: none; position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(180,0,0,0.9); z-index: 10; flex-direction: column; align-items: center; justify-content: center; }
        #my-id-display { font-weight: bold; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body data-theme="dark">

<div class="app">
    <div id="incoming_call" class="call-ui">
        <i class="fas fa-phone-alt fa-3x" style="margin-bottom: 20px;"></i>
        <div style="font-size: 20px; margin-bottom: 20px;">–í–•–û–î–Ø–©–ò–ô –í–´–ó–û–í</div>
        <div>
            <button onclick="acceptCall()" style="background:#fff; color:#000; border:none; padding: 15px 30px;"><i class="fas fa-check"></i> –û–¢–í–ï–¢–ò–¢–¨</button>
            <button onclick="location.reload()" style="border-color:#fff; color:#fff; margin-left: 10px;"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div class="header">
        <div>ID: <span id="my-id-display" onclick="copyId()">...</span></div>
        <div>
            <button onclick="toggleTheme()"><i class="fas fa-adjust"></i></button>
            <button onclick="startVoice()"><i class="fas fa-phone"></i></button>
        </div>
    </div>

    <div id="chat">
        <div class="m"><b>–°–ò–°–¢–ï–ú–ê</b>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–µ—Ç–∏...</div>
    </div>

    <div id="sticker-panel" class="sticker-panel">
        <img src="https://i.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJndmR4ZWZ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1z/3o7TKMGpxx6rDS0M00/giphy.gif" onclick="sendSticker(this.src)">
        <img src="https://i.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJndmR4ZWZ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1z/l41lTfuxV5Wz1yP6M/giphy.gif" onclick="sendSticker(this.src)">
        <img src="https://i.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJndmR4ZWZ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1z/3o7TKVUn7iM8FMEU24/giphy.gif" onclick="sendSticker(this.src)">
        <img src="https://i.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHJndmR4ZWZ4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1z/26vUAAqMhH7R36UvK/giphy.gif" onclick="sendSticker(this.src)">
    </div>

    <div class="controls">
        <div class="row">
            <input type="text" id="target-id" placeholder="ID –¶–ï–õ–ò">
            <button onclick="connectToPeer()"><i class="fas fa-link"></i></button>
        </div>
        <div class="row">
            <button onclick="toggleStickers()"><i class="fas fa-smile"></i></button>
            <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
        </div>
        <button onclick="document.getElementById('file-input').click()" style="width:100%"><i class="fas fa-paperclip"></i> –ü–ï–†–ï–î–ê–¢–¨ –§–ê–ô–õ</button>
        <input type="file" id="file-input" style="display:none" onchange="sendFile(this)">
    </div>
</div>

<script>
    let myId = Math.random().toString(36).substr(2, 4).toUpperCase();
    const peer = new Peer('NODE-' + myId, { config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }]} });

    let conn;
    let callActive;

    peer.on('open', (id) => {
        document.getElementById('my-id-display').innerText = myId;
        log("–°–ò–°–¢–ï–ú–ê", "–£–∑–µ–ª –∞–∫—Ç–∏–≤–µ–Ω. HTTPS –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω.");
    });

    peer.on('connection', (c) => { 
        conn = c; 
        setupConn(); 
    });

    peer.on('call', (call) => {
        callActive = call;
        document.getElementById('incoming_call').style.display = 'flex';
    });

    function connectToPeer() {
        const tId = document.getElementById('target-id').value.toUpperCase();
        conn = peer.connect('NODE-' + tId);
        setupConn();
    }

    function setupConn() {
        conn.on('open', () => log("–°–ò–°–¢–ï–ú–ê", "–ö–∞–Ω–∞–ª —Å–≤—è–∑–∏ –æ—Ç–∫—Ä—ã—Ç."));
        conn.on('data', (data) => {
            if (data.type === 'sticker') log("–°–û–ë–ï–°–ï–î–ù–ò–ö", `<img src="${data.url}" class="sticker">`);
            else if (data.type === 'file') handleFileData(data);
            else log("–°–û–ë–ï–°–ï–î–ù–ò–ö", data);
        });
    }

    function sendMsg() {
        const msg = document.getElementById('msg-input').value;
        if(conn && conn.open) {
            conn.send(msg);
            log("–í–´", msg, true);
            document.getElementById('msg-input').value = '';
        }
    }

    function toggleStickers() {
        const panel = document.getElementById('sticker-panel');
        panel.style.display = panel.style.display === 'grid' ? 'none' : 'grid';
    }

    function sendSticker(url) {
        if(conn && conn.open) {
            conn.send({type: 'sticker', url: url});
            log("–í–´", `<img src="${url}" class="sticker">`, true);
            toggleStickers();
        }
    }

    function sendFile(input) {
        const file = input.files[0];
        if(conn && conn.open && file) {
            conn.send({ type: 'file', file: file, fileName: file.name, fileType: file.type });
            log("–í–´", `–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${file.name}`, true);
        }
    }

    function handleFileData(data) {
        const blob = new Blob([data.file], {type: data.fileType});
        const url = URL.createObjectURL(blob);
        log("–°–û–ë–ï–°–ï–î–ù–ò–ö", `<a href="${url}" download="${data.fileName}" style="color:var(--accent)">üíæ –°–∫–∞—á–∞—Ç—å ${data.fileName}</a>`);
    }

    async function startVoice() {
        const tId = document.getElementById('target-id').value.toUpperCase();
        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
        const call = peer.call('NODE-' + tId, stream);
        call.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
        log("–°–ò–°–¢–ï–ú–ê", "–í—ã–∑–æ–≤ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω...");
    }

    async function acceptCall() {
        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
        callActive.answer(stream);
        document.getElementById('incoming_call').style.display = 'none';
        callActive.on('stream', rs => { const a = new Audio(); a.srcObject = rs; a.play(); });
    }

    function toggleTheme() {
        document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    function copyId() {
        navigator.clipboard.writeText(myId);
        alert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: " + myId);
    }

    function log(user, msg, own = false) {
        const chat = document.getElementById('chat');
        const div = document.createElement('div');
        div.className = 'm' + (own ? ' own' : '');
        div.innerHTML = `<b>${user}</b>${msg}`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }
</script>
</body>
</html>